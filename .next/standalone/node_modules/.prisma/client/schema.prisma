// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =====================
// ENUMS
// =====================

enum UserRole {
  SISWA
  PENGAJAR
  ADMIN
}

enum Gender {
  LAKI_LAKI
  PEREMPUAN
}

// =====================
// MODELS
// =====================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String
  name         String // @deprecated - use fullName instead, kept for backwards compatibility
  fullName     String? // Full name
  shortName    String? // Nickname/short name
  phone        String?
  profileImage String?
  asalSekolah  String?
  class_       String?  @db.VarChar(30)
  gender       Gender?
  domicile     String?  @db.VarChar(50)
  ages         Int?
  role         UserRole @default(SISWA)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  bankSoals      BankSoal[]     @relation("UploadedBy")
  classSessions  ClassSession[] @relation("CreatedBy")
  attendances    Attendance[]   @relation("StudentAttendance")
  tryOutsCreated TryOut[]       @relation("TryOutCreator")
  results        Result[]       @relation("StudentResults")

  @@map("users")
}

model BankSoalCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  bankSoals BankSoal[]

  @@map("bank_soal_categories")
}

model BankSoal {
  id           String   @id @default(cuid())
  title        String
  description  String?
  fileUrl      String
  filePublicId String? // Cloudinary public ID for deletion
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  categoryId String
  category   BankSoalCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  uploadedById String
  uploadedBy   User   @relation("UploadedBy", fields: [uploadedById], references: [id], onDelete: Cascade)

  @@map("bank_soals")
}

model ClassSession {
  id            String   @id @default(cuid())
  title         String
  description   String?
  scheduledAt   DateTime
  zoomLink      String?
  zoomMeetingId String?
  zoomPasscode  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  createdById String
  createdBy   User   @relation("CreatedBy", fields: [createdById], references: [id], onDelete: Cascade)

  attendances Attendance[]

  @@map("class_sessions")
}

model Attendance {
  id         String   @id @default(cuid())
  attendedAt DateTime @default(now())

  // Relations
  classSessionId String
  classSession   ClassSession @relation(fields: [classSessionId], references: [id], onDelete: Cascade)

  studentId String
  student   User   @relation("StudentAttendance", fields: [studentId], references: [id], onDelete: Cascade)

  // Unique constraint: one attendance per student per session
  @@unique([studentId, classSessionId])
  @@map("attendances")
}

model Schedule {
  id          String   @id @default(cuid())
  title       String
  description String?
  scheduledAt DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("schedules")
}

model TryOut {
  id          String   @id @default(cuid())
  title       String
  description String?
  timeLimit   Int // Time limit in minutes (required)
  totalScore  Int // Total score for all questions (computed)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  createdById String
  createdBy   User   @relation("TryOutCreator", fields: [createdById], references: [id], onDelete: Cascade)

  questions Question[]
  results   Result[]
}

model Question {
  id             String   @id @default(cuid())
  content        String // Question text
  options        String // JSON array of 5 options: ["Option A", "Option B", "Option C", "Option D", "Option E"]
  correctAnswer  Int // Index of correct option (0-4)
  score          Int      @default(1) // Points for this question
  imageUrl       String? // Cloudflare R2 image URL for question attachment (optional)
  attachmentText String? // Additional text description or context (optional)
  createdAt      DateTime @default(now())

  // Relations
  tryOutId String
  tryOut   TryOut @relation(fields: [tryOutId], references: [id], onDelete: Cascade)

  answers Answer[]
}

model Answer {
  id        String   @id @default(cuid())
  answer    Int // Selected option index (0-4)
  isCorrect Boolean // Auto-graded
  createdAt DateTime @default(now())

  // Relations
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  resultId String
  result   Result @relation(fields: [resultId], references: [id], onDelete: Cascade)
}

model Result {
  id          String   @id @default(cuid())
  score       Int // Total score obtained
  totalScore  Int // Maximum possible score
  completedAt DateTime @default(now())

  // Relations
  studentId String
  student   User   @relation("StudentResults", fields: [studentId], references: [id], onDelete: Cascade)

  tryOutId String
  tryOut   TryOut @relation(fields: [tryOutId], references: [id], onDelete: Cascade)

  answers Answer[]

  // Unique constraint: one result per student per try-out (enforces single attempt)
  @@unique([studentId, tryOutId])
  @@map("results")
}
